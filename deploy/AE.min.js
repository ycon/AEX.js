/*

 Released under the MIT license
 Author: Yannick Connan
 Version: 0.1.1 - Build: 17228 (2012/04/08 09:09 AM)
*/
(function(S){var k={VERSION:"0.1.1"};(function(a){function b(a,b,c,d,h){this._listener=b;this._isOnce=c;this.context=d;this._signal=a;this._priority=h||0}function c(a,b){if("function"!==typeof a)throw Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",b));}var d={VERSION:"0.7.1"};b.prototype={active:!0,params:null,execute:function(a){var b;this.active&&this._listener&&(a=this.params?this.params.concat(a):a,b=this._listener.apply(this.context,a),this._isOnce&&this.detach());
return b},detach:function(){return this.isBound()?this._signal.remove(this._listener):null},isBound:function(){return!!this._signal&&!!this._listener},getListener:function(){return this._listener},_destroy:function(){delete this._signal;delete this._listener;delete this.context},isOnce:function(){return this._isOnce},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}};d.Signal=function(){this._bindings=[];this._prevParams=null};
d.Signal.prototype={memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(a,c,d,j){var h=this._indexOfListener(a);if(-1!==h){if(a=this._bindings[h],a.isOnce()!==c)throw Error("You cannot add"+(c?"":"Once")+"() then add"+(!c?"":"Once")+"() the same listener without removing the relationship first.");}else a=new b(this,a,c,d,j),this._addBinding(a);this.memorize&&this._prevParams&&a.execute(this._prevParams);return a},_addBinding:function(a){var b=this._bindings.length;do--b;while(this._bindings[b]&&
a._priority<=this._bindings[b]._priority);this._bindings.splice(b+1,0,a)},_indexOfListener:function(a){for(var b=this._bindings.length;b--;)if(this._bindings[b]._listener===a)return b;return-1},has:function(a){return-1!==this._indexOfListener(a)},add:function(a,b,d){c(a,"add");return this._registerListener(a,!1,b,d)},addOnce:function(a,b,d){c(a,"addOnce");return this._registerListener(a,!0,b,d)},remove:function(a){c(a,"remove");var b=this._indexOfListener(a);-1!==b&&(this._bindings[b]._destroy(),
this._bindings.splice(b,1));return a},removeAll:function(){for(var a=this._bindings.length;a--;)this._bindings[a]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(a){if(this.active){var b=Array.prototype.slice.call(arguments),c=this._bindings.length,d;if(this.memorize)this._prevParams=b;if(c){d=this._bindings.slice();this._shouldPropagate=!0;do c--;while(d[c]&&this._shouldPropagate&&!1!==d[c].execute(b))}}},
forget:function(){this._prevParams=null},dispose:function(){this.removeAll();delete this._bindings;delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};"function"===typeof define&&define.amd?define("signals",[],d):"undefined"!==typeof module&&module.exports?module.exports=d:a.signals=d})(this);var M=this.signals,G=function(a,b,c,d){var e=0.5*(b-a),a=0.5*(a+b),b=d.clone();sum=0.3478548451*b.multiplyScalar(2*(a+-0.8611363116*
e)).add(c).lengthSq();sum+=0.3478548451*b.transfer(d).multiplyScalar(2*(a+0.8611363116*e)).add(c).lengthSq();sum+=0.6521451549*b.transfer(d).multiplyScalar(2*(a+-0.3399810436*e)).add(c).lengthSq();return sum+=0.6521451549*b.transfer(d).multiplyScalar(2*(a+0.3399810436*e)).add(c).lengthSq()},O=function(a,b,c,d,e,f){var g=a.clone(),j=d.clone();if(c.equals(d))return e.curveTo(g.lerp(b,0.89),d),e;if(b.equals(a))return e.curveTo(j.lerp(c,0.89),d),e;g.lerp(b,1.5);j.lerp(c,1.5);f||(f=(Math.max(Math.max(g.max(),
j.max()),Math.max(a.max(),d.max()))-Math.min(Math.min(g.min(),j.min()),Math.min(a.min(),d.min())))/350);var h=Math.sqrt(10.3923048/g.distance(j)*f);if(1<h)e.curveTo(g.lerp(j,0.5),d);else{var a=a.clone(),y=a.clone().lerp(b,h),q=c.clone().lerp(d,h),p=b.clone().lerp(c,h),l=y.clone().lerp(p,h),b=p.lerp(q,h),k=l.clone().lerp(b,h),g=a.clone().lerp(y,1.5);j.transfer(k).lerp(l,1.5);e.curveTo(g.lerp(j,0.5),k.clone());0.5>h&&(h=1-h/(1-h),b=b.clone(),c=q.clone(),a.transfer(k),y.transfer(a).lerp(b,h),q.transfer(c).lerp(d,
h),p.transfer(b).lerp(c,h),l.transfer(y).lerp(p,h),b=p.lerp(q,h),k.transfer(l).lerp(b,h),O(a,y,l.clone(),k.clone(),e,f));g=k.clone().lerp(b,1.5);j=d.clone().lerp(q,1.5);e.curveTo(g.lerp(j,0.5),d.clone())}return e},P=function(a){if(!(a instanceof this.type_))throw"not the right type";},w=function(a){this.items_=[];this.type_=Object;if(a&&a.prototype instanceof this.type_)this.type_=a;this.on={add:new M.Signal,remove:new M.Signal,swap:new M.Signal}};w.prototype={constructor:w,items_:null,type_:null,
index:function(a){return this.items_.indexOf(a)},have:function(a){return-1!==this.index(a)},get:function(a){return this.items_[a]},getLength:function(){return this.items_.length},add:function(a){P.call(this,a);if(this.have(a))throw"item already present";this.items_.push(a);this.on.add.dispatch(a,this.length-1,this)},insert:function(a,b){P.call(this,a);var c=this.items_;if(this.have(a))throw"item already present";b<c.length?c.splice(b,0,a):c.push(a);c=Math.max(b,this.length-1);this.on.add.dispatch(a,
c,this)},remove:function(a){var b=this.items_,c=b.indexOf(a);if(-1!==c)b.splice(c,1),this.on.remove.dispatch(a,c,this);else throw"item not present";},swap:function(a,b){var c=this.items_,d=c.indexOf(a),e=c.indexOf(b);if(-1!==d&&-1!==e)c[d]=b,c[e]=a,this.on.swap.dispatch(d,e,this);else throw"one of the items not present";},each:function(a){for(var b=this.items_,c=b.length,d=0;d<c;d++)a(b[d])}};k.Stack=w;var H=function(a,b,c,d,e){this.p1x=a;this.p1y=b;this.p2x=c;this.p2y=d;this.cx=3*a;this.bx=3*(c-
a)-this.cx;this.ax=1-this.cx-this.bx;this.cy=3*b;this.by=3*(d-b)-this.cy;this.ay=1-this.cy-this.by;this.ax3=3*this.ax;this.bx2=2*this.bx;this.epsilon=1/(100*(e||100))};H.prototype={constructor:H,sampleCurveX:function(a){return((this.ax*a+this.bx)*a+this.cx)*a},sampleCurveY:function(a){return((this.ay*a+this.by)*a+this.cy)*a},ease:function(a){return this.sampleCurveY(this.solveCurveX(a))},solveCurveX:function(a){var b=this.fabs,c=this.epsilon,d=this.ax3,e=this.bx2,f=this.cx,g,j,h,y;for(g=a,y=0;8>y;y++){j=
this.sampleCurveX(g)-a;if(b(j)<c)return g;h=(d*g+e)*g+f;if(1.0E-6>b(h))break;g-=j/h}d=0;e=1;g=a;if(g<d)return d;if(g>e)return e;for(;d<e;){j=this.sampleCurveX(g);if(b(j-a)<c)break;a>j?d=g:e=g;g=0.5*(e-d)+d}return g},fabs:function(a){return 0<=a?a:0-a}};var m=function(){arguments.length&&this.injectArray(arguments)};m.prototype={constructor:m,m11:1,m12:0,m13:0,m14:0,m21:0,m22:1,m23:0,m24:0,m31:0,m32:0,m33:1,m34:0,m41:0,m42:0,m43:0,m44:1,set:function(a,b,c,d,e,f,g,j,h,y,k,p,l,m,n,o){this.m11=a;this.m12=
b;this.m13=c;this.m14=d;this.m21=e;this.m22=f;this.m23=g;this.m24=j;this.m31=h;this.m32=y;this.m33=k;this.m34=p;this.m41=l;this.m42=m;this.m43=n;this.m44=o;return this},injectArray:function(a){return this.set.apply(this,a)},injectMatrix:function(a){this.m11=a.m11;this.m12=a.m12;this.m13=a.m13;this.m14=a.m14;this.m21=a.m21;this.m22=a.m22;this.m23=a.m23;this.m24=a.m24;this.m31=a.m31;this.m32=a.m32;this.m33=a.m33;this.m34=a.m34;this.m41=a.m41;this.m42=a.m42;this.m43=a.m43;this.m44=a.m44;return this},
identity:function(){this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return this},translation:function(a,b,c){this.set(1,0,0,0,0,1,0,0,0,0,1,0,a||0,b||0,c||0,1);return this},translate:function(a,b,c){this.m41+=a||0;this.m42+=b||0;this.m43+=c||0;return this},scaling:function(a,b,c){this.set(a||0,0,0,0,0,b||0,0,0,0,0,c||0,0,0,0,0,1);return this},scale:function(a,b,c){a=a||1.0E-6;b=b||1.0E-6;c=c||1.0E-6;if(1!==a||1!==b||1!==c)this.m11*=a,this.m21*=a,this.m31*=a,this.m41*=a,this.m12*=b,this.m22*=b,this.m32*=
b,this.m42*=b,this.m13*=c,this.m23*=c,this.m33*=c,this.m43*=c;return this},rotation:function(a,b,c){this.identity();var d=Math.PI/180,a=(a||0)*d,b=(b||0)*d,c=(-c||0)*d,e=Math.cos,f=Math.sin,d=e(a),a=f(a),g=e(b),b=f(b),e=e(c),c=f(c),f=d*e,j=d*c,h=a*e,k=a*c;this.m11=g*e;this.m12=h*b-j;this.m13=f*b+k;this.m21=g*c;this.m22=k*b+f;this.m23=j*b-h;this.m31=-b;this.m32=a*g;this.m33=d*g;return this},rotate:function(a,b,c){return a||b||c?this.multiply((new m).rotation(a,b,c)):this},lookingAt:function(a,b,c){var a=
a||0,b=b||0,c=-c||0,d=Math.sqrt(a*a+b*b+c*c);d&&(a/=d,b/=d,c/=d,this.set(-c,0,a,0,-a*b,a*a+c*c,-c*b,0,-a,-b,-c,0,0,0,0,1));return this},lookAt:function(a,b,c){return a||b?this.multiply((new m).lookingAt(a,b,c)):this},invert:function(){var a=this.m11,b=this.m12,c=this.m13,d=this.m21,e=this.m22,f=this.m23,g=this.m31,j=this.m32,h=this.m33,k=this.m41,q=this.m42,p=this.m43,l=1/(-c*e*g+b*f*g+c*d*j-a*f*j-b*d*h+a*e*h);this.m11=(-f*j+e*h)*l;this.m12=(c*j-b*h)*l;this.m13=(-c*e+b*f)*l;this.m14=0;this.m21=(f*
g-d*h)*l;this.m22=(-c*g+a*h)*l;this.m23=(c*d-a*f)*l;this.m24=0;this.m31=(-e*g+d*j)*l;this.m32=(b*g-a*j)*l;this.m33=(-b*d+a*e)*l;this.m34=0;this.m41=(f*j*k-e*h*k-f*g*q+d*h*q+e*g*p-d*j*p)*l;this.m42=(b*h*k-c*j*k+c*g*q-a*h*q-b*g*p+a*j*p)*l;this.m43=(c*e*k-b*f*k-c*d*q+a*f*q+b*d*p-a*e*p)*l;this.m44=1;return this},createInvert:function(){return this.clone().invert()},clone:function(){return(new m).set(this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,
this.m41,this.m42,this.m43,this.m44)},join:function(a,b){var c=a.m11,d=a.m12,e=a.m13,f=a.m14,g=a.m21,j=a.m22,h=a.m23,k=a.m24,q=a.m31,p=a.m32,l=a.m33,m=a.m34,n=a.m41,o=a.m42,r=a.m43,s=a.m44,t=b.m11,u=b.m12,v=b.m13,w=b.m14,x=b.m21,z=b.m22,A=b.m23,B=b.m24,C=b.m31,D=b.m32,E=b.m33,F=b.m34,G=b.m41,H=b.m42,I=b.m43,J=b.m44;this.m11=c*t+d*x+e*C+f*G;this.m12=c*u+d*z+e*D+f*H;this.m13=c*v+d*A+e*E+f*I;this.m14=c*w+d*B+e*F+f*J;this.m21=g*t+j*x+h*C+k*G;this.m22=g*u+j*z+h*D+k*H;this.m23=g*v+j*A+h*E+k*I;this.m24=
g*w+j*B+h*F+k*J;this.m31=q*t+p*x+l*C+m*G;this.m32=q*u+p*z+l*D+m*H;this.m33=q*v+p*A+l*E+m*I;this.m34=q*w+p*B+l*F+m*J;this.m41=n*t+o*x+r*C+s*G;this.m42=n*u+o*z+r*D+s*H;this.m43=n*v+o*A+r*E+s*I;this.m44=n*w+o*B+r*F+s*J;return this},multiply:function(a){return this.join(this,a)},preMultiply:function(a){return this.join(a,this)},toString:function(){return this.m13||this.m23||1!==this.m33||this.m43?"matrix3d("+this.m11.toFixed(4)+","+this.m12.toFixed(4)+","+this.m13.toFixed(4)+","+this.m14.toFixed(4)+","+
this.m21.toFixed(4)+","+this.m22.toFixed(4)+","+this.m23.toFixed(4)+","+this.m24.toFixed(4)+","+this.m31.toFixed(4)+","+this.m32.toFixed(4)+","+this.m33.toFixed(4)+","+this.m34.toFixed(4)+","+this.m41.toFixed(4)+","+this.m42.toFixed(4)+","+this.m43.toFixed(4)+","+this.m44.toFixed(4)+")":"matrix("+this.m11.toFixed(4)+","+this.m12.toFixed(4)+","+this.m21.toFixed(4)+","+this.m22.toFixed(4)+","+this.m31.toFixed(4)+","+this.m32.toFixed(4)+")"},toArray:function(){return[this.m11,this.m12,this.m13,this.m14,
this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44]}};k.Matrix=m;var n=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};n.prototype={constructor:n,set:function(a,b,c){this.x=a;this.y=b;this.z=c;return this},transfer:function(a){this.x=a.x;this.y=a.y;this.z=a.z||0;return this},setX:function(a){this.x=a;return this},setY:function(a){this.y=a;return this},setZ:function(a){this.z=a;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=
a.z;return this},clone:function(){return new n(this.x,this.y,this.z)},add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},addScalar:function(a){this.x+=a;this.y+=a;this.z+=a;return this},sub:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},multiply:function(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;this.z*=a;return this},divide:function(a){this.x/=a.x;this.y/=a.y;this.z/=a.z;return this},divideScalar:function(a){a?(this.x/=
a,this.y/=a,this.z/=a):this.z=this.y=this.x=0;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},lerp:function(a,b){this.x+=(a.x-this.x)*b;this.y+=(a.y-this.y)*b;this.z+=(a.z-this.z)*b;return this},cross:function(a){var b=this.x,c=this.y,d=this.z;this.x=c*a.z-d*a.y;this.y=d*a.x-b*a.z;this.z=b*a.y-
c*a.x;return this},distance:function(a){return Math.sqrt(this.distanceSq(a))},distanceSq:function(a){return this.clone().sub(a).lengthSq()},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z},isZero:function(){return 1.0E-4>this.lengthSq()},max:function(){return Math.max(this.x,Math.max(this.y,this.z))},min:function(){return Math.min(this.x,Math.min(this.y,this.z))}};k.Vector=n;var I=function(a,b,c,d){this.x=a||0;this.y=b||0;this.width=c||100;this.height=d||100};I.prototype={constructor:I,
clone:function(){return new I(this.x,this.y,this.width,this.height)},compare:function(a){return null===a||a.x!==this.x||a.y!==this.y||a.width!==this.width||a.height!==this.height?!1:!0}};var z=function(a,b){this.start=a;this.end=b;this.update=!0};z.prototype={constructor:z,length:function(){if(this.update)this.length_=this.start.distance(this.end),this.update=!1;return this.length_},getVect:function(a){return this.start.clone().interpolate(this.end,a)}};k.Line=z;var J=function(a,b,c){this.start=a;
this.anchor=b;this.end=c;this.update=!0};J.prototype={constructor:J,length:function(){if(this.update){this.update=!1;var a=this.anchor.clone().sub(this.start).multiplyScalar(2),b=this.start.clone().sub(this.anchor.clone().multiplyScalar(2)).add(this.end),c=Math.sqrt,d,e,f;d=c(G(0,0.25,a,b))/5.65685425;e=c(G(0.25,0.5,a,b))/5.65685425;f=c(G(0.5,0.75,a,b))/5.65685425;a=d+e+f+c(G(0.75,1,a,b))/5.65685425;f=(d+e+f)/a;e=(d+e)/a;d/=a;this.length_=a;this.inverse_=[d,e,f,0.5+(1-d/(e-d))/4,0.5-(1-(1-f)/(f-e))/
5]}return this.length_},getVect:function(a){this.length();var b,c=this.inverse_,d;d=c[0];var e=c[1],f=c[2];b=c[3];c=c[4];a>=f?(a=(a-f)/(1-f),b=c,d=0.75):a>=e?(a=(a-e)/(f-e),d=0.5,b=c):a>=d?(a=(a-d)/(e-d),d=0.25):(a/=d,d=0);b=0.25*(2*(1-a)*a*b+a*a)+d;return this.start.clone().lerp(this.anchor,b).lerp(this.anchor.clone().lerp(this.end,b),b)}};k.QuadCurve=J;var K=function(a){this.start=a||0;this.elements=[];this.update=!0};K.prototype={constructor:K,length:function(){if(this.update){var a=0,b=this.elements.length,
c;this.update=!1;this.lengths_=[a];for(c=0;c<b;c++)a+=this.elements[c].length(),this.lengths_.push(a);this.lastItemPos_=this.lastPos_=0;this.length_=a}return this.length_},getItem:function(a){for(var a=a*this.length(),b=a>=this.lastPos_?1:-1,c=this.elements.length,d,e,f=this.lastItemPos_;f<c;f+=b)if(d=this.lengths_[f],e=this.elements[f],a>=d&&a<d+e.length())return this.lastItemPos_=f,this.lastPos_=d,e},getVect:function(a){var b=this.getItem(a),a=a*this.length();return b?b.getVect((a-this.lastPos_)/
b.length()):this.start.clone()},lineTo:function(a){this.elements.push(new z(this.start,a));this.start=a;this.update=!0},curveTo:function(a,b){this.elements.push(new J(this.start,a,b));this.start=b;this.update=!0},cubicCurveTo:function(a,b,c){this.elements.push(new A(this.start,a,b,c));this.start=c;this.update=!0}};k.Path=K;var A=function(a,b,c,d){this.start=a;this.a1=b;this.a2=c;this.end=d;this.update=!0};A.prototype={constructor:A,length:function(){if(this.update)this.update=!1,this.path=O(this.start,
this.a1,this.a2,this.end,new K(this.start)),this.length_=this.path.length();return this.length_},getVect:function(a){this.length();return this.path.getVect(a)}};k.CubicCurve=A;var L=function(a,b,c,d,e,f,g){this.to=b;this.length=c;this.previous=a;if(d||e||f||g)this.easing=new H(d,e,f,g,duration)};L.prototype.get=function(a){if(!this.previous)return this.to;var b=this.previous.to,c=this.to-this.from;if(0===c||a>=this.length)return this.to;if(0>=a)return b;a=Math.min(a/this.length,1);this.easing&&(a=
this.easing.ease(a));return b+c*a};var N=function(a,b,c,d,e,f){this.path=a;this.length=b;if(c||d||e||f)this.easing=new H(c,d,e,f,b)};N.prototype.get=function(a){a/=this.length;this.easing&&(a=this.easing.ease(a));return this.path.getVect(a)};var Q=function(a,b){this.path={end:a};this.length=b};Q.prototype.get=function(){return this.path.end.clone()};var D=function(a,b,c,d){this.offset=a;this.keys_=[];this.obj_=b;this.prop_=c;this.update=!0;this.lastItem_={to:d};this.lastPos_=this.lastItemPos_=0};
D.prototype={constructor:D,length:function(){if(this.update){var a=this.offset,b=this.keys_.length,c;this.update=!1;this.lengths_=[a];for(c=1;c<b;c++)a+=this.keys_[c].length,this.lengths_.push(a);this.lastPos_=this.offset;this.lastItemPos_=0;this.length_=a}return this.length_},num:function(){return this.keys_.length},get:function(a){var b=this.length(),c=this.keys_.length,d;if(a<this.offset||a>=b)return this.keys_[c-1].get(1);for(var e=a>=this.lastPos_?1:-1,f=this.lastItemPos_;f<c;f+=e)if(b=this.lengths_[f],
d=this.keys_[f],a>=b&&a<b+d.length)return this.lastItemPos_=f,this.lastPos_=b,d.get(a-b)},set:function(a){a=this.get(a);if(a!==this.obj_[this.prop_]&&(this.obj_[this.prop_]=a,!1!==this.obj_.update))this.obj_.update=!0},addLinear:function(a,b){var c=new L(this.lastItem_,a,b);this.keys_.push(c);this.lastItem_=c;this.update=!0},addBezier:function(a,b,c,d,e,f){a=new L(this.lastItem_,a,b,c,d,e,f);this.keys_.push(a);this.lastItem_=a;this.update=!0},addHold:function(a,b){var c=new L(null,a,b);this.keys_.push(c);
this.lastItem_=c;this.update=!0}};k.Keys=D;var s=function(a,b,c,d){D.call(this,a,b,c,d);if(d)this.lastItem_={path:{end:d}}};s.prototype=new D;s.prototype.constructor=s;s.prototype.set=function(a){a=this.get(a);if(!this.obj_.equals(a)&&(this.obj_.transfer(a),!1!==this.prop_.update))this.prop_.update=!0};s.prototype.addLinear=function(a,b,c,d){var e=this.lastItem_.path.end,a=!b&&!c||a.equals(c)&&e.equals(b)?new z(e,a):new A(e,b,c,a),d=new N(a,d);this.keys_.push(d);this.lastItem_=d;this.update=!0};s.prototype.addBezier=
function(a,b,c,d,e,f,g,j){var h=this.lastItem_.path.end,a=!b&&!c||a.equals(c)&&h.equals(b)?new z(h,a):new A(h,b,c,a),d=new N(a,d,e,f,g,j);this.keys_.push(d);this.lastItem_=d;this.update=!0};s.prototype.addHold=function(a,b){var c=new Q(a,b);this.keys_.push(c);this.lastItem_=c;this.update=!0};k.SpatialKeys=s;var t=function(){this.is3D=!0;this.parent=null;this.visible=!0;this.name=null};t.prototype.getMatrix=function(){if(!this.is3D)return this.getMatrix2D();var a=this.getLocalMatrix(),b=this.parent;
b&&a.multiply(b.getMatrix());return a};t.prototype.getMatrix2D=function(){var a=this.getLocalMatrix2D(),b=this.parent;b&&a.multiply(b.getMatrix2D());return a};t.prototype.getLocalMatrix=function(){return new m};t.prototype.getLocalMatrix2D=function(){return new m};var o=function(){t.call(this);this.filters=new w;this.masks=new w;this.collapse=!1;this.position=new n;this.anchor=new n;this.scale=new n(1,1,1);this.rotation=new n;this.orientation=new n;this.opacity=1};o.prototype=new t;o.prototype.constructor=
o;o.prototype.getLocalMatrix=function(){var a=this.position,b=this.anchor,c=this.scale,d=this.rotation,e=this.orientation;return(new m).translation(-b.x,-b.y,-b.z).scale(c.x,c.y,c.z).rotate(d.x,d.y,d.z).rotate(e.x,e.y,e.z).translate(a.x,a.y,-a.z)};o.prototype.getLocalMatrix2D=function(){var a=this.position,b=this.anchor,c=this.scale;return(new m).translation(-b.x,-b.y,0).scale(c.x,c.y,1).rotate(0,0,this.rotation.z).translate(a.x,a.y,0)};k.Layer=o;var u=function(){t.call(this);this.position=new n;
this.rotation=new n;this.target=new n;this.haveTarget=!0;this.zoom=1333.33;this.center=new n;this.is3D=!0};u.prototype=new t;u.prototype.constructor=u;u.prototype.getLocalMatrix=function(){var a=this.rotation,b=this.target,c=this.position,a=(new m).rotate(a.x,a.y,a.z);this.haveTarget&&a.lookAt(b.x-c.x,b.y-c.y,b.z-c.z);a.translate(c.x,c.y,-c.z);return a};u.prototype.getLocalMatrix2D=function(){return(new m).rotate(0,0,this.rotation.z).translate(this.position.x,this.position.y,0)};u.prototype.getCameraMatrix=
function(){var a=this.center;return(new m).translate(a.x,a.y,this.zoom).preMultiply(this.getMatrix().createInvert())};k.Camera=u;var E=function(){o.call(this);this.color="#000000";this.width=640;this.height=360};E.prototype=new o;E.prototype.constructor=E;k.Solid=E;var B=function(){o.call(this);this.layers=new w(o);this.cameras=new w(u);this.width=640;this.height=360};B.prototype=new o;B.prototype.constructor=B;B.prototype.getCamera=function(){var a=0,b=this.cameras.length,c=null,d=null,a=0;a:for(;a<
b;a++)if(c=this.cameras.get(a),c.visible){d=c;break a}return d};k.Composition=B;var F=function(){o.call(this);this.text="";this.textArea=new I(0,0,150,150);this.textClass=null;this.fontFamily="Arial";this.textColor="#888888";this.fontSize=18;this.lineHeight=1.2;this.letterSpacing=0;this.textAlign="left";this.verticalAlign="top";this.collapse=!0};F.prototype=new o;F.prototype.constructor=F;k.Text=F;var r=function(a){this.model=a;this.element=this.holder=document.createElement(this.tagName);this.prevScale=
0;this.visible=!1};r.prototype={constructor:r,tagName:"layer",visible:!1,setVisible:function(a){if(a!==this.visible)this.visible=a,this.element.style.display=a?void 0:"none"},render:function(a,b){var c=this.model,d=this.modifyMatrix(c.getMatrix());a&&d.multiply(a);d=this.modifyCollapse(d,b);this.element.style.WebkitTransform=d.toString();this.holder.style.opacity=1!==c.opacity?c.opacity:void 0},modifyCollapse:function(a,b){var c=this.element,d=this.holder,e=this.model;if(c===d===e.collapse)if(e.collapse){if(c=
this.element=document.createElement("transform"),d.parentElement)d.parentElement.replaceChild(c,d),c.style.WebkitTransform=d.style.WebkitTransform,c.appendChild(d)}else{if(c.parentElement)c.parentElement.replaceChild(d,c),d.style.WebkitTransform=c.style.WebkitTransform;this.element=d}if(e.collapse){var e=1,e=a.m21,f=a.m22,g=a.m23,c=this.prevScale,e=Math.sqrt(e*e+f*f+g*g)*(b/(b-a.m43));if(1.5<e/c||0.75>e/c)this.prevScale=e,d.style.WebkitTransform="scale("+e+","+e+")";d=1/e;a.preMultiply((new m).scaling(d,
d,1))}else this.prevScale=0;return a},modifyMatrix:function(a){return a}};var x=function(a){r.call(this,a)};x.prototype=new r(null);x.prototype.constructor=x;x.prototype.tagName="solid";x.prototype.render=function(a,b){r.prototype.render.call(this,a,b);var c=this.holder,d=this.model;c.style.width=d.width;c.style.height=d.height;c.style.backgroundColor=d.color};var C=function(a){this.text=a;r.call(this,a);this.oldText={text:null,textArea:null,textClass:null,fontFamily:null,textColor:null,fontSize:null,
lineHeight:null,letterSpacing:null,textAlign:null,verticalAlign:null}};C.prototype=new r(null);C.prototype.constructor=x;C.prototype.tagName="text";C.prototype.render=function(a,b){var c=this.text,d=this.oldText,e=!1,f,g,j;for(j in d)d.hasOwnProperty(j)&&(f=c[j],g=d[j],f!==g&&("object"!==typeof f||null===f)?(e=!0,d[j]=f):null!==f&&f.clone&&f.compare&&!f.compare(g)&&(e=!0,d[j]=f.clone()));if(e){c=this.holder;d=this.holder.style;e=this.text;f=e.fontSize;g=e.textArea.height;j=f*e.leading-f;i=0;d.width=
e.textArea.width+"px";d.color=e.textColor;d.textAlign=e.textAlign;d.fontFamily=e.fontFamily;d.fontSize=e.fontSize+"px";d.lineHeight=e.lineHeight+"em";var h=document.createTextNode(e.text);this.textNode?c.replaceChild(h,this.textNode):c.appendChild(h);for(this.textNode=h;6>=i&&c.offsetHeight-j>=g;)f*=0.92,j=f*e.leading-f,d.fontSize=f+"px",i++;this.offsetY=e.textArea.y-j/2;f=g-(c.offsetHeight-j/2);switch(e.verticalAlign){case "bottom":this.offsetY+=f;break;case "middle":this.offsetY+=f/2}d.height=c.offsetHeight+
5+"px"}r.prototype.render.call(this,a,b)};C.prototype.modifyMatrix=function(a){return a};var T=function(a,b){var c=R(a);this.holder.appendChild(c.element);this.layers.splice(b,0,c)},U=function(a,b){this.holder.removeChild(this.layers[b].element);this.layers.splice(b,1)},V=function(a,b){var c=this.layers[a];this.layers[a]=this.layers[b];this.layers[b]=c},R=function(a){return a instanceof B?new v(a):a instanceof E?new x(a):a instanceof F?new C(a):new r(a)},v=function(a){var b=this,c,d=a.layers.on;r.call(b,
a);b.composition=a;b.collapse=null;b.zoom=1333.33;b.width=0;b.height=0;b.layers=[];a.layers.each(function(a){c=R(a);b.holder.appendChild(c.element);b.layers.push(c)});d.add.add(T,b);d.remove.add(U,b);d.swap.add(V,b)};v.prototype=new r(null);v.prototype.constructor=v;v.prototype.tagName="composition";v.prototype.render=function(a,b,c){r.prototype.render.call(this,a,b);var a=this.layers,b=this.layers.length,d=this.model,e=this.element.style,f=c||!d.collapse?this.composition.getCamera():null,c=f?f.getCameraMatrix():
null,f=f?f.zoom:1333.33;if(this.collapse!==d.collapse)d.collapse?(e.WebkitTransformStyle="preserve-3d",e.WebkitPerspective=void 0,e.WebkitPerspectiveOrigin=void 0):(this.zoom=this.height=this.width=null,e.WebkitTransformStyle="flat"),this.collapse=d.collapse;if(!this.collapse){if(this.width!==d.width||this.heigh!==d.height)this.width=d.width,this.height=d.height,e.width=this.width.toString()+"px",e.height=this.height.toString()+"px",e.WebkitPerspectiveOrigin=(this.width/2).toString()+"px "+(this.height/
2).toString()+"px";if(this.zoom!==f)this.zoom=f,e.WebkitPerspective=this.zoom.toString()+"px"}for(d=0;d<b;d++)e=a[d],e.visible!==e.model.visible&&e.setVisible(e.model.visible),e.visible&&e.render(c,f)};v.prototype.modifyCollapse=function(a){return a};s=function(a,b){this.scene=new v(a);this.camera=b;this.element=document.createElement("scene");this.element.appendChild(this.scene.element);if(!document.getElementById("AEStyleSheet")){var c=document.createElement("style");c.id="AEStyleSheet";c.type=
"text/css";c.rel="stylesheet";c.media="screen";c.title="AEStyleSheet";c.innerHTML="scene * {position:absolute;display:block;top:0px;left:0px;word-wrap:break-word;-webkit-font-smoothing:antialiased;-moz-transform-origin:0% 0%;-webkit-transform-origin:0% 0%;-ms-transform-origin:0% 0%;}";document.getElementsByTagName("head")[0].appendChild(c)}};s.prototype.render=function(){this.scene.render(null,null,this.camera)};k.DomRenderer=s;"function"===typeof define&&define.amd?define("AE",[],k):"undefined"!==
typeof module&&module.exports?module.exports=k:S.AE=k})(this);
/*

 Released under the MIT license
 Author: Yannick Connan
 Version: 0.1.1 - Build: 17231 (2012/04/09 01:43 AM)
*/
(function(S){var k={VERSION:"0.1.1"};(function(a){function b(a,b,c,d,h){this._listener=b;this._isOnce=c;this.context=d;this._signal=a;this._priority=h||0}function c(a,b){if("function"!==typeof a)throw Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",b));}var d={VERSION:"0.7.1"};b.prototype={active:!0,params:null,execute:function(a){var b;this.active&&this._listener&&(a=this.params?this.params.concat(a):a,b=this._listener.apply(this.context,a),this._isOnce&&this.detach());
return b},detach:function(){return this.isBound()?this._signal.remove(this._listener):null},isBound:function(){return!!this._signal&&!!this._listener},getListener:function(){return this._listener},_destroy:function(){delete this._signal;delete this._listener;delete this.context},isOnce:function(){return this._isOnce},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}};d.Signal=function(){this._bindings=[];this._prevParams=null};
d.Signal.prototype={memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(a,c,d,j){var h=this._indexOfListener(a);if(-1!==h){if(a=this._bindings[h],a.isOnce()!==c)throw Error("You cannot add"+(c?"":"Once")+"() then add"+(!c?"":"Once")+"() the same listener without removing the relationship first.");}else a=new b(this,a,c,d,j),this._addBinding(a);this.memorize&&this._prevParams&&a.execute(this._prevParams);return a},_addBinding:function(a){var b=this._bindings.length;do--b;while(this._bindings[b]&&
a._priority<=this._bindings[b]._priority);this._bindings.splice(b+1,0,a)},_indexOfListener:function(a){for(var b=this._bindings.length;b--;)if(this._bindings[b]._listener===a)return b;return-1},has:function(a){return-1!==this._indexOfListener(a)},add:function(a,b,d){c(a,"add");return this._registerListener(a,!1,b,d)},addOnce:function(a,b,d){c(a,"addOnce");return this._registerListener(a,!0,b,d)},remove:function(a){c(a,"remove");var b=this._indexOfListener(a);-1!==b&&(this._bindings[b]._destroy(),
this._bindings.splice(b,1));return a},removeAll:function(){for(var a=this._bindings.length;a--;)this._bindings[a]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(a){if(this.active){var b=Array.prototype.slice.call(arguments),c=this._bindings.length,d;if(this.memorize)this._prevParams=b;if(c){d=this._bindings.slice();this._shouldPropagate=!0;do c--;while(d[c]&&this._shouldPropagate&&!1!==d[c].execute(b))}}},
forget:function(){this._prevParams=null},dispose:function(){this.removeAll();delete this._bindings;delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};"function"===typeof define&&define.amd?define("signals",[],d):"undefined"!==typeof module&&module.exports?module.exports=d:a.signals=d})(this);var N=this.signals;if(!Function.prototype.bind)Function.prototype.bind=function(a){var b=this;if("function"!=typeof b)throw new TypeError("Function.prototype.bind called on incompatible "+
b);var c=slice.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var e=new e,f=b.apply(e,c.concat(slice.call(arguments)));return Object(f)===f?f:e}return b.apply(a,c.concat(slice.call(arguments)))};return d};if(!Array.isArray)Array.isArray=function(a){return"[object Array]"==Object.prototype.toString.call(a)};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a){var b=toObject(this),c=b.length>>>0;if(!c)return-1;var d=0;1<arguments.length&&(d=
toInteger(arguments[1]));for(d=0<=d?d:Math.max(0,c+d);d<c;d++)if(d in b&&b[d]===a)return d;return-1};var H=function(a,b,c,d){var e=0.5*(b-a),a=0.5*(a+b),b=d.clone();sum=0.3478548451*b.multiplyScalar(2*(a+-0.8611363116*e)).add(c).lengthSq();sum+=0.3478548451*b.transfer(d).multiplyScalar(2*(a+0.8611363116*e)).add(c).lengthSq();sum+=0.6521451549*b.transfer(d).multiplyScalar(2*(a+-0.3399810436*e)).add(c).lengthSq();return sum+=0.6521451549*b.transfer(d).multiplyScalar(2*(a+0.3399810436*e)).add(c).lengthSq()},
O=function(a,b,c,d,e,f){var g=a.clone(),j=d.clone();if(c.equals(d))return e.curveTo(g.lerp(b,0.89),d),e;if(b.equals(a))return e.curveTo(j.lerp(c,0.89),d),e;g.lerp(b,1.5);j.lerp(c,1.5);f||(f=(Math.max(Math.max(g.max(),j.max()),Math.max(a.max(),d.max()))-Math.min(Math.min(g.min(),j.min()),Math.min(a.min(),d.min())))/350);var h=Math.sqrt(10.3923048/g.distance(j)*f);if(1<h)e.curveTo(g.lerp(j,0.5),d);else{var a=a.clone(),o=a.clone().lerp(b,h),s=c.clone().lerp(d,h),m=b.clone().lerp(c,h),l=o.clone().lerp(m,
h),b=m.lerp(s,h),k=l.clone().lerp(b,h),g=a.clone().lerp(o,1.5);j.transfer(k).lerp(l,1.5);e.curveTo(g.lerp(j,0.5),k.clone());0.5>h&&(h=1-h/(1-h),b=b.clone(),c=s.clone(),a.transfer(k),o.transfer(a).lerp(b,h),s.transfer(c).lerp(d,h),m.transfer(b).lerp(c,h),l.transfer(o).lerp(m,h),b=m.lerp(s,h),k.transfer(l).lerp(b,h),O(a,o,l.clone(),k.clone(),e,f));g=k.clone().lerp(b,1.5);j=d.clone().lerp(s,1.5);e.curveTo(g.lerp(j,0.5),d.clone())}return e},P=function(a){if(!(a instanceof this.type_))throw"not the right type";
},t=function(a){this.items_=[];this.type_=Object;if(a&&a.prototype instanceof this.type_)this.type_=a;this.on={add:new N.Signal,remove:new N.Signal,swap:new N.Signal}};t.prototype={constructor:t,items_:null,type_:null,index:function(a){return this.items_.indexOf(a)},have:function(a){return-1!==this.index(a)},get:function(a){return this.items_[a]},getLength:function(){return this.items_.length},add:function(a){P.call(this,a);if(this.have(a))throw"item already present";this.items_.push(a);this.on.add.dispatch(a,
this.length-1,this)},insert:function(a,b){P.call(this,a);var c=this.items_;if(this.have(a))throw"item already present";b<c.length?c.splice(b,0,a):c.push(a);c=Math.max(b,this.length-1);this.on.add.dispatch(a,c,this)},remove:function(a){var b=this.items_,c=b.indexOf(a);if(-1!==c)b.splice(c,1),this.on.remove.dispatch(a,c,this);else throw"item not present";},swap:function(a,b){var c=this.items_,d=c.indexOf(a),e=c.indexOf(b);if(-1!==d&&-1!==e)c[d]=b,c[e]=a,this.on.swap.dispatch(d,e,this);else throw"one of the items not present";
},each:function(a){for(var b=this.items_,c=b.length,d=0;d<c;d++)a(b[d])}};k.Stack=t;var T={ease:function(a,b,c,d,e,f){b=b||0;d=d||0;a=this.solveCurveX(a||0,c||0,e,f);c=3*b;b=3*(d-b)-c;return(((1-c-b)*a+b)*a+c)*a},solveCurveX:function(a,b,c,d){var e=this.fabs,f=3*a,a=3*(b-a)+f,b=1-f-a,g=2*a,j=3*b,h,o,s,m;d||(d=1.0E-4);for(h=c,m=0;8>m;m++){o=((b*h+a)*h+f)*h;if(e(o)<d)return h;s=(j*h+g)*h+f;if(1.0E-6>e(s))break;h-=o/s}g=0;j=1;h=c;if(h<g)return g;if(h>j)return j;for(;g<j;){o=((b*h+a)*h+f)*h;if(e(o-c)<
d)break;c>o?g=h:j=h;h=0.5*(j-g)+g}return h},fabs:function(a){return 0<=a?a:0-a}},n=function(){arguments.length&&this.injectArray(arguments)};n.prototype={constructor:n,m11:1,m12:0,m13:0,m14:0,m21:0,m22:1,m23:0,m24:0,m31:0,m32:0,m33:1,m34:0,m41:0,m42:0,m43:0,m44:1,set:function(a,b,c,d,e,f,g,j,h,o,s,m,l,k,p,n){this.m11=a;this.m12=b;this.m13=c;this.m14=d;this.m21=e;this.m22=f;this.m23=g;this.m24=j;this.m31=h;this.m32=o;this.m33=s;this.m34=m;this.m41=l;this.m42=k;this.m43=p;this.m44=n;return this},injectArray:function(a){return this.set.apply(this,
a)},injectMatrix:function(a){this.m11=a.m11;this.m12=a.m12;this.m13=a.m13;this.m14=a.m14;this.m21=a.m21;this.m22=a.m22;this.m23=a.m23;this.m24=a.m24;this.m31=a.m31;this.m32=a.m32;this.m33=a.m33;this.m34=a.m34;this.m41=a.m41;this.m42=a.m42;this.m43=a.m43;this.m44=a.m44;return this},identity:function(){this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return this},translation:function(a,b,c){this.set(1,0,0,0,0,1,0,0,0,0,1,0,a||0,b||0,c||0,1);return this},translate:function(a,b,c){this.m41+=a||0;this.m42+=b||
0;this.m43+=c||0;return this},scaling:function(a,b,c){this.set(a||0,0,0,0,0,b||0,0,0,0,0,c||0,0,0,0,0,1);return this},scale:function(a,b,c){a=a||1.0E-6;b=b||1.0E-6;c=c||1.0E-6;if(1!==a||1!==b||1!==c)this.m11*=a,this.m21*=a,this.m31*=a,this.m41*=a,this.m12*=b,this.m22*=b,this.m32*=b,this.m42*=b,this.m13*=c,this.m23*=c,this.m33*=c,this.m43*=c;return this},rotation:function(a,b,c){this.identity();var d=Math.PI/180,a=(a||0)*d,b=(b||0)*d,c=(-c||0)*d,e=Math.cos,f=Math.sin,d=e(a),a=f(a),g=e(b),b=f(b),e=
e(c),c=f(c),f=d*e,j=d*c,h=a*e,o=a*c;this.m11=g*e;this.m12=h*b-j;this.m13=f*b+o;this.m21=g*c;this.m22=o*b+f;this.m23=j*b-h;this.m31=-b;this.m32=a*g;this.m33=d*g;return this},rotate:function(a,b,c){return a||b||c?this.multiply((new n).rotation(a,b,c)):this},lookingAt:function(a,b,c){var a=a||0,b=b||0,c=-c||0,d=Math.sqrt(a*a+b*b+c*c);d&&(a/=d,b/=d,c/=d,this.set(-c,0,a,0,-a*b,a*a+c*c,-c*b,0,-a,-b,-c,0,0,0,0,1));return this},lookAt:function(a,b,c){return a||b?this.multiply((new n).lookingAt(a,b,c)):this},
invert:function(){var a=this.m11,b=this.m12,c=this.m13,d=this.m21,e=this.m22,f=this.m23,g=this.m31,j=this.m32,h=this.m33,o=this.m41,k=this.m42,m=this.m43,l=1/(-c*e*g+b*f*g+c*d*j-a*f*j-b*d*h+a*e*h);this.m11=(-f*j+e*h)*l;this.m12=(c*j-b*h)*l;this.m13=(-c*e+b*f)*l;this.m14=0;this.m21=(f*g-d*h)*l;this.m22=(-c*g+a*h)*l;this.m23=(c*d-a*f)*l;this.m24=0;this.m31=(-e*g+d*j)*l;this.m32=(b*g-a*j)*l;this.m33=(-b*d+a*e)*l;this.m34=0;this.m41=(f*j*o-e*h*o-f*g*k+d*h*k+e*g*m-d*j*m)*l;this.m42=(b*h*o-c*j*o+c*g*k-
a*h*k-b*g*m+a*j*m)*l;this.m43=(c*e*o-b*f*o-c*d*k+a*f*k+b*d*m-a*e*m)*l;this.m44=1;return this},createInvert:function(){return this.clone().invert()},clone:function(){return(new n).set(this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44)},join:function(a,b){var c=a.m11,d=a.m12,e=a.m13,f=a.m14,g=a.m21,j=a.m22,h=a.m23,k=a.m24,s=a.m31,m=a.m32,l=a.m33,p=a.m34,n=a.m41,q=a.m42,r=a.m43,t=a.m44,u=b.m11,v=b.m12,w=b.m13,
x=b.m14,y=b.m21,A=b.m22,B=b.m23,C=b.m24,D=b.m31,E=b.m32,F=b.m33,G=b.m34,H=b.m41,I=b.m42,J=b.m43,K=b.m44;this.m11=c*u+d*y+e*D+f*H;this.m12=c*v+d*A+e*E+f*I;this.m13=c*w+d*B+e*F+f*J;this.m14=c*x+d*C+e*G+f*K;this.m21=g*u+j*y+h*D+k*H;this.m22=g*v+j*A+h*E+k*I;this.m23=g*w+j*B+h*F+k*J;this.m24=g*x+j*C+h*G+k*K;this.m31=s*u+m*y+l*D+p*H;this.m32=s*v+m*A+l*E+p*I;this.m33=s*w+m*B+l*F+p*J;this.m34=s*x+m*C+l*G+p*K;this.m41=n*u+q*y+r*D+t*H;this.m42=n*v+q*A+r*E+t*I;this.m43=n*w+q*B+r*F+t*J;this.m44=n*x+q*C+r*G+t*
K;return this},multiply:function(a){return this.join(this,a)},preMultiply:function(a){return this.join(a,this)},toString:function(){return this.m13||this.m23||1!==this.m33||this.m43?"matrix3d("+this.m11.toFixed(4)+","+this.m12.toFixed(4)+","+this.m13.toFixed(4)+","+this.m14.toFixed(4)+","+this.m21.toFixed(4)+","+this.m22.toFixed(4)+","+this.m23.toFixed(4)+","+this.m24.toFixed(4)+","+this.m31.toFixed(4)+","+this.m32.toFixed(4)+","+this.m33.toFixed(4)+","+this.m34.toFixed(4)+","+this.m41.toFixed(4)+
","+this.m42.toFixed(4)+","+this.m43.toFixed(4)+","+this.m44.toFixed(4)+")":"matrix("+this.m11.toFixed(4)+","+this.m12.toFixed(4)+","+this.m21.toFixed(4)+","+this.m22.toFixed(4)+","+this.m31.toFixed(4)+","+this.m32.toFixed(4)+")"},toArray:function(){return[this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44]}};k.Matrix=n;var p=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};p.prototype={constructor:p,
set:function(a,b,c){this.x=a;this.y=b;this.z=c;return this},transfer:function(a){this.x=a.x;this.y=a.y;this.z=a.z||0;return this},setX:function(a){this.x=a;return this},setY:function(a){this.y=a;return this},setZ:function(a){this.z=a;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},clone:function(){return new p(this.x,this.y,this.z)},add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},addScalar:function(a){this.x+=a;this.y+=a;this.z+=a;return this},sub:function(a){this.x-=
a.x;this.y-=a.y;this.z-=a.z;return this},multiply:function(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;this.z*=a;return this},divide:function(a){this.x/=a.x;this.y/=a.y;this.z/=a.z;return this},divideScalar:function(a){a?(this.x/=a,this.y/=a,this.z/=a):this.z=this.y=this.x=0;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.lengthSq())},
normalize:function(){return this.divideScalar(this.length())},lerp:function(a,b){this.x+=(a.x-this.x)*b;this.y+=(a.y-this.y)*b;this.z+=(a.z-this.z)*b;return this},cross:function(a){var b=this.x,c=this.y,d=this.z;this.x=c*a.z-d*a.y;this.y=d*a.x-b*a.z;this.z=b*a.y-c*a.x;return this},distance:function(a){return Math.sqrt(this.distanceSq(a))},distanceSq:function(a){return this.clone().sub(a).lengthSq()},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z},isZero:function(){return 1.0E-4>
this.lengthSq()},max:function(){return Math.max(this.x,Math.max(this.y,this.z))},min:function(){return Math.min(this.x,Math.min(this.y,this.z))}};k.Vector=p;var I=function(a,b,c,d){this.x=a||0;this.y=b||0;this.width=c||100;this.height=d||100};I.prototype={constructor:I,clone:function(){return new I(this.x,this.y,this.width,this.height)},compare:function(a){return null===a||a.x!==this.x||a.y!==this.y||a.width!==this.width||a.height!==this.height?!1:!0}};var J=function(a,b){this.start=a;this.end=b;
this.update=!0};J.prototype={constructor:J,length:function(){if(this.update)this.length_=this.start.distance(this.end),this.update=!1;return this.length_},getVect:function(a){return this.start.clone().interpolate(this.end,a)}};k.Line=J;var K=function(a,b,c){this.start=a;this.anchor=b;this.end=c;this.update=!0};K.prototype={constructor:K,length:function(){if(this.update){this.update=!1;var a=this.anchor.clone().sub(this.start).multiplyScalar(2),b=this.start.clone().sub(this.anchor.clone().multiplyScalar(2)).add(this.end),
c=Math.sqrt,d,e,f;d=c(H(0,0.25,a,b))/5.65685425;e=c(H(0.25,0.5,a,b))/5.65685425;f=c(H(0.5,0.75,a,b))/5.65685425;a=d+e+f+c(H(0.75,1,a,b))/5.65685425;f=(d+e+f)/a;e=(d+e)/a;d/=a;this.length_=a;this.inverse_=[d,e,f,0.5+(1-d/(e-d))/4,0.5-(1-(1-f)/(f-e))/5]}return this.length_},getVect:function(a){this.length();var b,c=this.inverse_,d;d=c[0];var e=c[1],f=c[2];b=c[3];c=c[4];a>=f?(a=(a-f)/(1-f),b=c,d=0.75):a>=e?(a=(a-e)/(f-e),d=0.5,b=c):a>=d?(a=(a-d)/(e-d),d=0.25):(a/=d,d=0);b=0.25*(2*(1-a)*a*b+a*a)+d;return this.start.clone().lerp(this.anchor,
b).lerp(this.anchor.clone().lerp(this.end,b),b)}};k.QuadCurve=K;var L=function(a){this.start=a||0;this.elements=[];this.update=!0};L.prototype={constructor:L,length:function(){if(this.update){var a=0,b=this.elements.length,c;this.update=!1;this.lengths_=[a];for(c=0;c<b;c++)a+=this.elements[c].length(),this.lengths_.push(a);this.lastItemPos_=this.lastPos_=0;this.length_=a}return this.length_},getItem:function(a){for(var a=a*this.length(),b=a>=this.lastPos_?1:-1,c=this.elements.length,d,e,f=this.lastItemPos_;f<
c;f+=b)if(d=this.lengths_[f],e=this.elements[f],a>=d&&a<d+e.length())return this.lastItemPos_=f,this.lastPos_=d,e},getVect:function(a){var b=this.getItem(a),a=a*this.length();return b?b.getVect((a-this.lastPos_)/b.length()):this.start.clone()},lineTo:function(a){this.elements.push(new J(this.start,a));this.start=a;this.update=!0},curveTo:function(a,b){this.elements.push(new K(this.start,a,b));this.start=b;this.update=!0},cubicCurveTo:function(a,b,c){this.elements.push(new F(this.start,a,b,c));this.start=
c;this.update=!0}};k.Path=L;var F=function(a,b,c,d){this.start=a;this.a1=b;this.a2=c;this.end=d;this.update=!0};F.prototype={constructor:F,length:function(){if(this.update)this.update=!1,this.path=O(this.start,this.a1,this.a2,this.end,new L(this.start)),this.length_=this.path.length();return this.length_},getVect:function(a){this.length();return this.path.getVect(a)}};k.CubicCurve=F;var M=function(a,b,c,d){t.call(this);this.layer=a;this.inPoint=b||0;this.outPoint=c||1/0;this.source=d;this.startTime=
0;this.speed=1;this.remap=new x};M.prototype=new t;M.prototype.constructor=CompAnimation;M.prototype.render=function(a){var b=this.layer,c=this.items_;if(a>=this.inPoint&&a<=this.outPoint){b.visible=!0;for(var b=c.length,d=0;d<b;d++)c[d].set(a);this.source&&(this.keys.num()?this.source.render(this.keys.get(a-this.startTime)):this.source.render((a-this.startTime)*this.speed))}else b.visible=!1};var C=function(a){t.call(this);this.item=a};C.prototype=new t;C.prototype.constructor=C;C.prototype.render=
function(){for(var a=this.items_,b=a.length,c=0;c<b;c++)a[c].render(time)};var U=function(a,b,c){this.offset=a;this.position_=0;this.value=b;this.isHold=c;this.outY=this.outX=this.inY=this.inX=0;this.path=this.outTangent=this.inTangent=null;this.update=!1},x=function(a,b){this.target=a;this.property=b;this.keys_=[];this.length_=0};x.prototype={constructor:x,length:function(){var a=this.keys_,b,c,d,e;if(this.update){d=a.length;for(c=e=0;c<d;c++)if(b=a[c],e+=b.offset,b.position_=e,b.update&&b.path&&
(b.inTangent||b.outTangent))this.path=null,b.update=!1;this.length_=e;this.update=!1}return this.length_},num:function(){return this.keys_.length},indexAt:function(a){var b=this.keys_,c=this.prevIndex_,d=a>=this.prevPosition_?1:-1;this.length();a:for(;b[c];){if(a>=b[c].position_&&(!b[c+1]||a<b[c+1].position_))break a;c+=d}this.prevIndex_=c;this.prevPosition_=a;return this.prevIndex_},get:function(a){var b=this.indexAt(a),c=this.keys_[b];if(0===b&&a<=c.offset||b>=this.num()-1||c.isHold)return c.value;
b=this.keys_[b+1];a=(a-c.position_)/b.offset;if(c.outX||c.outY||b.inX||b.inY)a=T.ease(c.outX,c.outY,b.inX,b.inY);return this.interpolate(c,b,a)},interpolate:function(a,b,c){return a.value+(b.value-a.value)*c},set:function(a){a=this.get(a);this.target[this.property]!==a&&(this.target[this.property]=a)},add:function(a,b,c){b=new U(a,b,c);this.length_+=a;b.position_=this.length_;this.keys_.push(b);return b}};k.Keys=x;var y=function(a,b){x.call(this,a,b)};y.prototype=new x;y.prototype.constructor=y;y.prototype.interpolate=
function(a,b,c){if(a.update)a.path=a.outTangent&&b.inTangent?new F(a.value,a.outTangent.clone().add(a.value),a.inTangent.clone().add(b.value),b.value):null,a.update=!1;return a.path?a.path.getVect(c):a.value.clone().lerp(new_key.value,c)};y.prototype.set=function(a){var a=this.get(a),b=this.target[this.property];b.equals&&!b.equals(a)&&b.transfer(a)};k.SpatialKeys=y;var v=function(){this.is3D=!0;this.parent=null;this.visible=!0;this.name=null};v.prototype.getMatrix=function(){if(!this.is3D)return this.getMatrix2D();
var a=this.getLocalMatrix(),b=this.parent;b&&a.multiply(b.getMatrix());return a};v.prototype.getMatrix2D=function(){var a=this.getLocalMatrix2D(),b=this.parent;b&&a.multiply(b.getMatrix2D());return a};v.prototype.getLocalMatrix=function(){return new n};v.prototype.getLocalMatrix2D=function(){return new n};var q=function(){v.call(this);this.filters=new t;this.masks=new t;this.collapse=!1;this.position=new p;this.anchor=new p;this.scale=new p(1,1,1);this.rotation=new p;this.orientation=new p;this.opacity=
1};q.prototype=new v;q.prototype.constructor=q;q.prototype.getLocalMatrix=function(){var a=this.position,b=this.anchor,c=this.scale,d=this.rotation,e=this.orientation;return(new n).translation(-b.x,-b.y,-b.z).scale(c.x,c.y,c.z).rotate(d.x,d.y,d.z).rotate(e.x,e.y,e.z).translate(a.x,a.y,-a.z)};q.prototype.getLocalMatrix2D=function(){var a=this.position,b=this.anchor,c=this.scale;return(new n).translation(-b.x,-b.y,0).scale(c.x,c.y,1).rotate(0,0,this.rotation.z).translate(a.x,a.y,0)};k.Layer=q;var u=
function(){v.call(this);this.position=new p;this.rotation=new p;this.target=new p;this.haveTarget=!0;this.zoom=1333.33;this.center=new p;this.is3D=!0};u.prototype=new v;u.prototype.constructor=u;u.prototype.getLocalMatrix=function(){var a=this.rotation,b=this.target,c=this.position,a=(new n).rotate(a.x,a.y,a.z);this.haveTarget&&a.lookAt(b.x-c.x,b.y-c.y,b.z-c.z);a.translate(c.x,c.y,-c.z);return a};u.prototype.getLocalMatrix2D=function(){return(new n).rotate(0,0,this.rotation.z).translate(this.position.x,
this.position.y,0)};u.prototype.getCameraMatrix=function(){var a=this.center;return(new n).translate(a.x,a.y,this.zoom).preMultiply(this.getMatrix().createInvert())};k.Camera=u;var D=function(){q.call(this);this.color="#000000";this.width=640;this.height=360};D.prototype=new q;D.prototype.constructor=D;k.Solid=D;var A=function(){q.call(this);this.layers=new t(q);this.cameras=new t(u);this.width=640;this.height=360};A.prototype=new q;A.prototype.constructor=A;A.prototype.getCamera=function(){var a=
0,b=this.cameras.length,c=null,d=null,a=0;a:for(;a<b;a++)if(c=this.cameras.get(a),c.visible){d=c;break a}return d};k.Composition=A;var G=function(){q.call(this);this.text="";this.textArea=new I(0,0,150,150);this.textClass=null;this.fontFamily="Arial";this.textColor="#888888";this.fontSize=18;this.lineHeight=1.2;this.letterSpacing=0;this.textAlign="left";this.verticalAlign="top";this.collapse=!0};G.prototype=new q;G.prototype.constructor=G;k.Text=G;k.AEBuilder={build:function(a){return this.buildItem(a.items[a.root],
a.items)},buildItem:function(a,b){switch(a.type){case "Composition":return this.buildComp(a,b);case "Solid":return this.buildSolid(a,b);case "Image":return this.buildImage(a,b);case "Video":return this.buildVideo(a,b)}},buildComp:function(a,b){var c=new A,d=new C(c),e=c.layers,f,g,j;c.width=a.width;c.height=a.height;for(f=0;f<e.length;f++){g=e[f];j=null;switch(layer.type){case "Camera":j=this.buildCamera(g);break;case "Text":j=this.buildText(g);break;default:layer.source&&(j=this.buildItemLayer(g,
b))}j&&(d.add(j),(j.layer instanceof u?c.cameras:c.layers).add(j.layer))}return d},setLayer:function(a,b){var c=a.layer,d=b.transform;solid.name=b.name;solid.is3D=b.is3D||!1;d&&(this.setProp(c,"position",a,d.position),this.setProp(c,"anchor",a,d.anchor),this.setProp(c,"scale",a,d.scale),this.setProp(c,"opacity",a,d.opacity));solid.is3D?(this.setProp(c,"rotation",a,d.rotation),this.setProp(c,"orientation",a,d.orientation)):this.setProp(c.rotation,"z",a,d.rotation)},buildSolid:function(a){var b=new D,
c=new C(b);b.width=a.width;b.height=a.height;b.color=a.color;return c},buildItemLayer:function(a,b){var c=this.buildItem(b[a.source],b),d=new M(c.item,a.inPoint,a.outPoint);this.setLayer(d,a);d.source=c;d.startTime=a.startTime||0;d.speed=a.speed||1;return d},buildImage:function(){},buildVideo:function(){},buildCamera:function(){},buildText:function(){},dump:function(){},setProp:function(a,b,c,d){if(d&&0===d){var e,f,g,j,h,k,n,m,l,q;if(Array.isArray(d)){l=null;for(e=j=0;e<d.length;e++){f=d[e];n="object"!==
typeof f;h=(m=Array.isArray(f))||!n||f.e&&0===f.e.o;g=m?f[0]:n&&f.v?f.v:f;(q="object"===typeof g&&void 0!==g.x&&void 0!==g.y)&&(g=new p(g.x,g.y,g,z));null===l&&(k=(l=q)?new y(a,b):new x(a,b));m?j=f[1]:n&&void 0!==f.d&&(j=f.d||0);g=k.add(j,g,h);if(f.e&&Array.isArray(f.e.i))g.inX=f.e.i[0],g.inY=f.e.i[1];if(f.e&&Array.isArray(f.e.o))g.outX=f.e.o[0],g.outY=f.e.o[1];if(l&&f.t){if(Array.isArray(f.t.i))g.inTangent=new p(f.t.i[0],f.t.i[1],f.t.i[2]);if(Array.isArray(f.t.o))g.outTangent=new p(f.t.o[0],f.t.o[1],
f.t.o[2]);g.update=!0}}k&&c.add(k)}else prop&&Array.isArray(d.x)?(setProp(a[b],"x",c,d.x),prop.y&&setProp(a[b],"y",c,d.y),prop.z&&setProp(a[b],"z",c,d.z)):a[b]=d}}};var r=function(a){this.model=a;this.element=this.holder=document.createElement(this.tagName);this.prevScale=0;this.visible=!1};r.prototype={constructor:r,tagName:"layer",visible:!1,setVisible:function(a){if(a!==this.visible)this.visible=a,this.element.style.display=a?void 0:"none"},render:function(a,b){var c=this.model,d=this.modifyMatrix(c.getMatrix());
a&&d.multiply(a);d=this.modifyCollapse(d,b);this.element.style.WebkitTransform=d.toString();this.holder.style.opacity=1!==c.opacity?c.opacity:void 0},modifyCollapse:function(a,b){var c=this.element,d=this.holder,e=this.model;if(c===d===e.collapse)if(e.collapse){if(c=this.element=document.createElement("transform"),d.parentElement)d.parentElement.replaceChild(c,d),c.style.WebkitTransform=d.style.WebkitTransform,c.appendChild(d)}else{if(c.parentElement)c.parentElement.replaceChild(d,c),d.style.WebkitTransform=
c.style.WebkitTransform;this.element=d}if(e.collapse){var e=1,e=a.m21,f=a.m22,g=a.m23,c=this.prevScale,e=Math.sqrt(e*e+f*f+g*g)*(b/(b-a.m43));if(1.5<e/c||0.75>e/c)this.prevScale=e,d.style.WebkitTransform="scale("+e+","+e+")";d=1/e;a.preMultiply((new n).scaling(d,d,1))}else this.prevScale=0;return a},modifyMatrix:function(a){return a}};var B=function(a){r.call(this,a)};B.prototype=new r(null);B.prototype.constructor=B;B.prototype.tagName="solid";B.prototype.render=function(a,b){r.prototype.render.call(this,
a,b);var c=this.holder,d=this.model;c.style.width=d.width;c.style.height=d.height;c.style.backgroundColor=d.color};var E=function(a){this.text=a;r.call(this,a);this.oldText={text:null,textArea:null,textClass:null,fontFamily:null,textColor:null,fontSize:null,lineHeight:null,letterSpacing:null,textAlign:null,verticalAlign:null}};E.prototype=new r(null);E.prototype.constructor=B;E.prototype.tagName="text";E.prototype.render=function(a,b){var c=this.text,d=this.oldText,e=!1,f,g,j;for(j in d)d.hasOwnProperty(j)&&
(f=c[j],g=d[j],f!==g&&("object"!==typeof f||null===f)?(e=!0,d[j]=f):null!==f&&f.clone&&f.compare&&!f.compare(g)&&(e=!0,d[j]=f.clone()));if(e){c=this.holder;d=this.holder.style;e=this.text;f=e.fontSize;g=e.textArea.height;j=f*e.leading-f;i=0;d.width=e.textArea.width+"px";d.color=e.textColor;d.textAlign=e.textAlign;d.fontFamily=e.fontFamily;d.fontSize=e.fontSize+"px";d.lineHeight=e.lineHeight+"em";var h=document.createTextNode(e.text);this.textNode?c.replaceChild(h,this.textNode):c.appendChild(h);for(this.textNode=
h;6>=i&&c.offsetHeight-j>=g;)f*=0.92,j=f*e.leading-f,d.fontSize=f+"px",i++;this.offsetY=e.textArea.y-j/2;f=g-(c.offsetHeight-j/2);switch(e.verticalAlign){case "bottom":this.offsetY+=f;break;case "middle":this.offsetY+=f/2}d.height=c.offsetHeight+5+"px"}r.prototype.render.call(this,a,b)};E.prototype.modifyMatrix=function(a){return a};var V=function(a,b){var c=Q(a);this.holder.appendChild(c.element);this.layers.splice(b,0,c)},W=function(a,b){this.holder.removeChild(this.layers[b].element);this.layers.splice(b,
1)},X=function(a,b){var c=this.layers[a];this.layers[a]=this.layers[b];this.layers[b]=c},Q=function(a){return a instanceof A?new w(a):a instanceof D?new B(a):a instanceof G?new E(a):new r(a)},w=function(a){var b=this,c,d=a.layers.on;r.call(b,a);b.composition=a;b.collapse=null;b.zoom=1333.33;b.width=0;b.height=0;b.layers=[];a.layers.each(function(a){c=Q(a);b.holder.appendChild(c.element);b.layers.push(c)});d.add.add(V,b);d.remove.add(W,b);d.swap.add(X,b)};w.prototype=new r(null);w.prototype.constructor=
w;w.prototype.tagName="composition";w.prototype.render=function(a,b,c){r.prototype.render.call(this,a,b);var a=this.layers,b=this.layers.length,d=this.model,e=this.element.style,f=c||!d.collapse?this.composition.getCamera():null,c=f?f.getCameraMatrix():null,f=f?f.zoom:1333.33;if(this.collapse!==d.collapse)d.collapse?(e.WebkitTransformStyle="preserve-3d",e.WebkitPerspective=void 0,e.WebkitPerspectiveOrigin=void 0):(this.zoom=this.height=this.width=null,e.WebkitTransformStyle="flat"),this.collapse=
d.collapse;if(!this.collapse){if(this.width!==d.width||this.heigh!==d.height)this.width=d.width,this.height=d.height,e.width=this.width.toString()+"px",e.height=this.height.toString()+"px",e.WebkitPerspectiveOrigin=(this.width/2).toString()+"px "+(this.height/2).toString()+"px";if(this.zoom!==f)this.zoom=f,e.WebkitPerspective=this.zoom.toString()+"px"}for(d=0;d<b;d++)e=a[d],e.visible!==e.model.visible&&e.setVisible(e.model.visible),e.visible&&e.render(c,f)};w.prototype.modifyCollapse=function(a){return a};
var R=function(a,b){this.scene=new w(a);this.camera=b;this.element=document.createElement("scene");this.element.appendChild(this.scene.element);if(!document.getElementById("AEStyleSheet")){var c=document.createElement("style");c.id="AEStyleSheet";c.type="text/css";c.rel="stylesheet";c.media="screen";c.title="AEStyleSheet";c.innerHTML="scene * {position:absolute;display:block;top:0px;left:0px;word-wrap:break-word;-webkit-font-smoothing:antialiased;-moz-transform-origin:0% 0%;-webkit-transform-origin:0% 0%;-ms-transform-origin:0% 0%;}";
document.getElementsByTagName("head")[0].appendChild(c)}};R.prototype.render=function(){this.scene.render(null,null,this.camera)};k.DomRenderer=R;"function"===typeof define&&define.amd?define("AE",[],k):"undefined"!==typeof module&&module.exports?module.exports=k:S.AE=k})(this);